<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>WhisperRoom - Chat</title>
  <!-- Link to the external CSS file -->
  <link rel="stylesheet" href="css/chat.css">
</head>
<body>
  <div class="chat-container">
    <!-- Chat Header: Room info, Close/Leave buttons -->
    <div class="chat-header">
      <div id="roomInfo"></div>
      <button id="closeRoomBtn" style="display: none;">Close Room</button>
      <button id="leaveRoomBtn" style="display: none;">Leave Room</button>
    </div>

    <!-- Chat messages area -->
    <div class="chat-messages" id="chatMessages"></div>

    <!-- Typing indicator -->
    <div id="typingIndicator"></div>

    <!-- Message input bar with emoji and image upload -->
    <form id="messageForm" class="message-input-bar">
      <!-- New Image Upload Button and Hidden File Input -->
      <div class="image-container">
        <button type="button" class="image-button" id="imageBtn">
          <img src="/img/add.png" alt="Image" />
        </button>
        <input type="file" id="imageInput" accept="image/*" style="display: none;">
      </div>


      <!-- Emoji container for the input bar -->
      <div class="emoji-container">
        <button type="button" class="emoji-button" id="emojiBtn">
          <img src="/img/emoji.png" alt="Emoji" />
        </button>
        <!-- Horizontal emoji picker (hidden by default) -->
        <div id="emojiPicker" class="emoji-picker" style="display: none;">
          <span>😀</span>
          <span>😂</span>
          <span>😍</span>
          <span>😢</span>
          <span>😡</span>
        </div>
      </div>

      

      <!-- Text input for message -->
      <input 
        type="text"
        id="messageInput"
        class="chat-input"
        placeholder="Type your message..."
        required
      />

      <!-- Send button with PNG image -->
      <button type="submit" class="send-button" id="sendBtn">
        <img src="/img/send.png" alt="Send" />
      </button>
    </form>
  </div>

  <!-- Socket.io client script -->
  <script src="/socket.io/socket.io.js"></script>
  <script>
    /*********************************************************
     * 1. Socket.io Setup and Basic References
     *********************************************************/
    const socket = io();
    const username = localStorage.getItem('username');
    const action = localStorage.getItem('action');
    let roomCode = localStorage.getItem('roomCode');

    // UI element references
    const roomInfo = document.getElementById('roomInfo');
    const closeRoomBtn = document.getElementById('closeRoomBtn');
    const leaveRoomBtn = document.getElementById('leaveRoomBtn');
    const chatMessages = document.getElementById('chatMessages');
    const typingIndicator = document.getElementById('typingIndicator');
    const messageForm = document.getElementById('messageForm');
    const messageInput = document.getElementById('messageInput');
    const emojiBtn = document.getElementById('emojiBtn');
    const emojiPicker = document.getElementById('emojiPicker');
    const imageBtn = document.getElementById('imageBtn');
    const imageInput = document.getElementById('imageInput');

    let typingTimeout;

    /*********************************************************
     * 2. Host or Join Room
     *********************************************************/
    if (action === 'host') {
      socket.emit('host-room', { username });
      socket.on('room-hosted', code => {
        roomCode = code;
        roomInfo.innerHTML = `Room Code: ${roomCode} <button id="copyBtn">Copy</button>`;
        const copyBtn = document.getElementById('copyBtn');
        copyBtn.addEventListener('click', () => {
          navigator.clipboard.writeText(roomCode);
          alert('Room code copied!');
        });
      });
      closeRoomBtn.style.display = 'inline';
    } else if (action === 'join') {
      socket.emit('join-room', { username, roomCode });
      roomInfo.innerText = `Room Code: ${roomCode}`;  
      leaveRoomBtn.style.display = 'inline';
    }

    /*********************************************************
     * 3. Typing Indicator Logic
     *********************************************************/
    messageInput.addEventListener('input', () => {
      socket.emit('typing');
      clearTimeout(typingTimeout);
      typingTimeout = setTimeout(() => {
        socket.emit('stop-typing');
      }, 1000);
    });
    socket.on('typing', data => {
      typingIndicator.innerText = `${data.username} is typing...`;
    });
    socket.on('stop-typing', data => {
      if (typingIndicator.innerText === `${data.username} is typing...`) {
        typingIndicator.innerText = '';
      }
    });

    /*********************************************************
     * 4. Receiving Chat Messages (Text and Image)
     *********************************************************/
    socket.on('chat-message', data => {
      if (data.isSystem) {
        // System message
        const systemDiv = document.createElement('div');
        systemDiv.classList.add('system-message');
        systemDiv.innerHTML = data.message + `<div class="system-time">${data.timestamp}</div>`;
        chatMessages.appendChild(systemDiv);
      } else {
        // Create a wrapper for the message
        const wrapper = document.createElement('div');
        wrapper.classList.add('message-wrapper');
        wrapper.setAttribute('data-id', data.id);

        // Add "sent" or "received" class based on the sender
        if (data.username === username) {
          wrapper.classList.add('sent');
        } else {
          wrapper.classList.add('received');
        }

        // Message bubble
        const bubble = document.createElement('div');
        bubble.classList.add('message-bubble');
        bubble.classList.add(data.username === username ? 'sent' : 'received');

        // Footer for time + reaction aggregator
        const footerDiv = document.createElement('div');
        footerDiv.classList.add('msg-footer');
        const timeSpan = document.createElement('span');
        timeSpan.classList.add('msg-time');
        timeSpan.textContent = data.timestamp;
        const reactionDisplay = document.createElement('div');
        reactionDisplay.classList.add('reaction-display-inline');
        footerDiv.appendChild(timeSpan);
        footerDiv.appendChild(reactionDisplay);
        bubble.appendChild(footerDiv);

        // Reaction container outside the bubble
        const reactionContainer = document.createElement('div');
        if (data.username === username) {
          reactionContainer.classList.add('reaction-container-outside-sent');
        } else {
          reactionContainer.classList.add('reaction-container-outside-received');
        }
        const reactionBtn = document.createElement('button');
        reactionBtn.classList.add('reaction-btn-outside');
        const reactImg = document.createElement('img');
        reactImg.src = '/img/react.png';
        reactImg.alt = 'React';
        reactionBtn.appendChild(reactImg);
        reactionBtn.addEventListener('click', () => {
          const popup = wrapper.querySelector('.reaction-popup-outside');
          if (!popup) return;
          popup.style.display = (popup.style.display === 'none' || !popup.style.display)
            ? 'flex'
            : 'none';
        });
        const reactionPopup = document.createElement('div');
        reactionPopup.classList.add('reaction-popup-outside');
        reactionPopup.style.display = 'none';
        const availableReactions = ['👍', '❤️', '😂', '😮', '😢', '😡'];
        availableReactions.forEach(emoji => {
          const emojiSpan = document.createElement('span');
          emojiSpan.textContent = emoji;
          emojiSpan.addEventListener('click', () => {
            socket.emit('message-reaction', { messageId: data.id, reaction: emoji });
            reactionPopup.style.display = 'none';
          });
          reactionPopup.appendChild(emojiSpan);
        });
        reactionContainer.appendChild(reactionBtn);
        reactionContainer.appendChild(reactionPopup);

        // Display message content based on type
        if (data.type && data.type === 'image') {
          // Display an image message
          const imgElement = document.createElement('img');
          imgElement.src = data.message;
          imgElement.alt = 'Image';
          imgElement.style.maxWidth = '200px';
          imgElement.style.display = 'block';
          // Optional caption with sender's name
          const caption = document.createElement('span');
          caption.classList.add('msg-text');
          caption.textContent = `${data.username}`;
          bubble.insertBefore(caption, bubble.firstChild);
          bubble.insertBefore(imgElement, caption.nextSibling);
        } else {
          // Display a regular text message
          const msgText = document.createElement('span');
          msgText.classList.add('msg-text');
          msgText.textContent = `${data.username}: ${data.message}`;
          bubble.insertBefore(msgText, bubble.firstChild);
        }
        wrapper.appendChild(bubble);
        wrapper.appendChild(reactionContainer);
        chatMessages.appendChild(wrapper);
      }
    });

    // Listen for reaction updates
    socket.on('message-reaction-update', data => {
      console.log('Reaction update received:', data);
      const { messageId, reactions } = data;
      const wrapper = document.querySelector(`[data-id="${messageId}"]`);
      if (wrapper) {
        const display = wrapper.querySelector('.reaction-display-inline');
        if (!display) return;
        display.innerHTML = '';
        for (const emoji in reactions) {
          const count = reactions[emoji];
          const span = document.createElement('span');
          span.textContent = `${emoji} ${count}`;
          display.appendChild(span);
        }
      }
    });

    /*********************************************************
     * 5. Room Closed / Leave Logic
     *********************************************************/
    socket.on('room-closed', () => {
      alert('The room has been closed by the host.');
      window.location.href = '/';
    });
    closeRoomBtn.addEventListener('click', () => {
      socket.emit('close-room');
    });
    leaveRoomBtn.addEventListener('click', () => {
      socket.emit('leave-room');
      window.location.href = '/choose';
    });

    /*********************************************************
     * 6. Sending Messages (Text and Image)
     *********************************************************/
    // Sending text messages via the input field
    messageForm.addEventListener('submit', e => {
      e.preventDefault();
      const message = messageInput.value;
      if(message.trim() !== ''){
        socket.emit('chat-message', { type: 'text', data: message });
        messageInput.value = '';
        socket.emit('stop-typing');
      }
    });
    // Trigger file input when image button is clicked
    imageBtn.addEventListener('click', () => {
      imageInput.click();
    });
    // Handle image file selection and send image message
    imageInput.addEventListener('change', () => {
      const file = imageInput.files[0];
      if(file){
        const reader = new FileReader();
        reader.onload = function(e) {
          const imageData = e.target.result;
          socket.emit('chat-message', { type: 'image', data: imageData });
        };
        reader.readAsDataURL(file);
      }
      imageInput.value = '';
    });

    /*********************************************************
     * 7. Emoji Picker for the Input Bar
     *********************************************************/
    emojiBtn.addEventListener('click', () => {
      if (emojiPicker.style.display === 'none' || !emojiPicker.style.display) {
        emojiPicker.style.display = 'flex';
      } else {
        emojiPicker.style.display = 'none';
      }
    });
    emojiPicker.addEventListener('click', event => {
      if (event.target.tagName === 'SPAN') {
        messageInput.value += event.target.textContent;
      }
    });
  </script>
</body>
</html>
